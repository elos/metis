{{define "MulAccessors"}}
{{template "Include" $}}
{{template "Exclude" $}}
{{template "Iter" $}}
{{template "List" $}}
{{end}}

{{define "Include"}}
{{sig .Model}} Include{{name .This.Relation.Singular}}({{camel .This.Relation.Singular}} {{.Other.Type}}) {
    {{camel .Model.Kind}}.{{relationFieldName .This.Relation}} = append({{camel .Model.Kind}}.{{relationFieldName .This.Relation}}, {{camel .This.Relation.Singular}}.ID().String())
}
{{end}}

{{define "Exclude"}}
{{sig .Model}} Exclude{{name .This.Relation.Singular}}({{camel .This.Relation.Singular}} {{.Other.Type}}) {
    tmp := make([]string, 0)
    id := {{camel .This.Relation.Singular}}.ID().String()
    for _, s := range {{camel .Model.Kind}}.{{relationFieldName .This.Relation}} {
        if s != id {
            tmp = append(tmp, s)
        }
    }
    {{camel .Model.Kind}}.{{relationFieldName .This.Relation}} = tmp
}
{{end}}

{{define "Iter"}}
{{sig .Model}} {{name .This.Relation.Name}}Iter(db data.DB) (data.Iterator, error) {
    // not yet completely general
    return mongo.NewIDIter(mongo.NewIDSetFromStrings({{camel .Model.Kind}}.{{relationFieldName .This.Relation}}), db), nil
}
{{end}}

{{define "List"}}
{{sig .Model}} {{name .This.Relation.Name}}(db data.DB) ([]{{.Other.Type}}, error) {

    {{.This.Relation.Name}} := make([]{{.Other.Type}}, 0)
    iter := mongo.NewIDIter(mongo.NewIDSetFromStrings({{camel .Model.Kind}}.{{relationFieldName .This.Relation}}), db)
    {{.This.Relation.Singular}} := New{{name .Other.Kind}}()
    for iter.Next({{.This.Relation.Singular}}) {
        {{.This.Relation.Name}} = append({{.This.Relation.Name}}, {{.This.Relation.Singular}})
        {{.This.Relation.Singular}} = New{{name .Other.Kind}}()
    }
    return {{.This.Relation.Name}}, nil
}
{{end}}
